# WhisperElectron 应用设计文档

## 项目概述
WhisperElectron 是一个基于 Electron 和 React 的桌面应用，主要用于在 macOS 上进行录音和语音转录。应用支持全局快捷键触发录音，并在录音结束后自动进行转录。

## 技术栈
- Electron: 用于构建跨平台桌面应用
- React: 用于构建用户界面
- TypeScript: 提供类型安全
- Node.js: 用于后端服务
- SQLite: 用于本地数据存储
- FFmpeg: 用于音频处理
- Whisper API: 用于语音转录

## 系统架构

### 核心模块划分

1. **快捷键监听模块 (GlobalShortcut)**
   - 负责监听全局快捷键
   - 触发录音开始和结束
   - 与主进程通信
   - **实现方式：使用 Electron 官方 globalShortcut 模块，跨平台支持全局快捷键监听，无需第三方二进制依赖。支持应用最小化或后台运行时捕获快捷键。**
   - **每个快捷键项以 action 作为唯一 id，前后端所有操作、渲染、更新均以 action 唯一定位，避免 key 变动导致的同步和渲染问题。**
   - **用户修改快捷键、启用/禁用时，主进程会自动注销旧快捷键并注册新快捷键，保证全局监听始终与设置同步。**

2. **录音模块 (AudioRecorder)**
   - 处理音频录制
   - 音频格式转换
   - 临时文件管理

3. **API 通信模块 (APIClient)**
   - 处理与 Whisper API 的通信
   - 管理 API 密钥
   - 处理请求和响应

4. **转录处理模块 (TranscriptionProcessor)**
   - 处理转录结果
   - 文本格式化
   - 结果存储

5. **UI 模块 (React Components)**
   - 应用设置界面
   - 录音状态显示
   - 转录结果展示
   - 历史记录管理

### 数据流
1. 用户按下快捷键 → 触发录音
2. 录音模块开始录制
3. 用户再次按下快捷键 → 停止录音
4. 录音文件保存并发送到 API
5. API 返回转录结果
6. 转录结果处理和展示

## 详细设计

### 1. 快捷键监听模块

#### 系统级快捷键实现
- **使用 Electron 官方 globalShortcut 模块，跨平台支持全局快捷键监听。无需 node-global-key-listener 或本地二进制依赖。**
- 支持在应用最小化或后台运行时捕获快捷键
- 只能监听组合键（如 CommandOrControl+Shift+S），不能监听单独修饰键
- 快捷键注册失败时（如被系统或其他应用占用）有日志提示

#### 快捷键动作类型
- START_RECORDING: 开始录音
- STOP_RECORDING: 停止录音
- CANCEL_RECORDING: 取消录音

#### 快捷键配置
- 每个快捷键包含：**唯一 action id**、快捷键组合、描述、启用状态
- 支持动态更新快捷键配置
- 支持启用/禁用单个快捷键
- 配置持久化存储（后续可扩展）

#### 状态管理
- 维护录音状态（是否正在录音）
- 确保快捷键动作在正确的状态下触发
- 提供状态重置功能

#### 权限处理
- **macOS 下无需额外辅助功能权限，只需 Electron 主进程在即可监听全局快捷键**

#### 错误处理和恢复机制
- 处理快捷键冲突（同一组合键只能被一个 action 占用）
- 注册失败有日志提示
- 处理系统休眠/唤醒后的重新初始化

#### 性能优化
- Electron globalShortcut 本身已做优化
- 只注册启用状态的快捷键，动态注册/注销

### 2. 录音模块

#### 录音配置
- 音频格式：WAV/MP3
- 采样率：44.1kHz/48kHz
- 声道数：单声道/立体声
- 比特率：128kbps/256kbps

#### 核心功能
- 音频录制
- 格式转换
- 临时文件管理
- 录音状态管理

#### 文件管理
- 临时文件存储
- 自动清理机制
- 文件命名规则
- 存储位置配置

### 3. API 通信模块

#### API 配置
- API 密钥管理
- 模型选择
- 语言设置
- 请求超时设置

#### 通信机制
- 异步请求处理
- 错误重试机制
- 响应解析
- 结果缓存

### 4. 转录处理模块

#### 结果处理
- 文本格式化
- 时间戳处理
- 分段处理
- 标点符号优化

#### 存储管理
- 本地存储
- 历史记录
- 导出功能
- 数据备份

## 项目结构
```
whisperElectron/
├── src/
│   ├── main/                 # Electron 主进程
│   │   ├── index.ts         # 主进程入口
│   │   ├── shortcut.ts      # 快捷键管理
│   │   └── audio.ts         # 音频处理
│   ├── renderer/            # React 渲染进程
│   │   ├── App.tsx         # 主应用组件
│   │   ├── components/     # UI 组件
│   │   └── hooks/          # React Hooks
│   └── shared/             # 共享代码
│       ├── types.ts        # 类型定义
│       └── constants.ts    # 常量定义
├── public/                 # 静态资源
├── package.json
└── tsconfig.json
```

## 开发计划

### 第一阶段：基础架构
1. 搭建 Electron + React 项目框架
2. 实现基本的应用窗口和界面
3. 配置开发环境和构建流程

### 第二阶段：核心功能
1. 实现快捷键监听模块
2. 实现录音功能
3. 实现与 Whisper API 的集成

### 第三阶段：UI 和优化
1. 完善用户界面
2. 添加设置功能
3. 实现历史记录管理
4. 优化性能和用户体验

## 注意事项
1. 需要处理 macOS 的权限问题（麦克风访问权限和辅助功能权限）
2. 确保应用在后台运行时能正常响应快捷键
3. 注意音频文件的管理和清理
4. 保护 API 密钥的安全性
5. 考虑网络连接问题时的错误处理
6. 处理快捷键冲突问题
7. 确保系统级快捷键的可靠性
8. 提供权限获取失败时的降级方案
9. 处理快捷键配置的版本兼容性
10. 确保快捷键状态与录音状态的一致性

## 后续优化方向
1. 支持更多音频格式
2. 添加实时转录功能
3. 支持更多语言
4. 添加导出功能
5. 支持自定义快捷键
6. 添加音频编辑功能

## UI 设计

### 设计风格
- 遵循 macOS 原生设计规范
- 使用系统原生控件和交互模式
- 保持简洁、直观的用户界面
- 支持深色/浅色模式自动切换

### 页面结构

#### 1. 主页面 (MainWindow)
- **布局结构**
  - 顶部工具栏
  - 任务列表区域
  - 状态栏

- **顶部工具栏**
  - 录音控制按钮
    - 开始录音按钮（带状态指示）
    - 停止录音按钮
  - 设置按钮（打开设置页面）
  - 当前录音状态指示器

- **任务列表**
  - 分页展示（每页5条）
  - 按时间倒序排列
  - 列表项显示：
    - 任务创建时间
    - 录音时长
    - 转录状态
    - 简短预览文本
  - 点击列表项进入任务详情页
  - 支持下拉刷新
  - 分页导航控件

#### 2. 设置页面 (SettingsWindow)
- **布局结构**
  - 分组设置面板
  - 底部操作按钮

- **API 配置组**
  - API 地址输入框
  - API 端口输入框
  - 测试连接按钮
  - 保存按钮

- **录音配置组**
  - 录音格式选择
    - 单选按钮组
    - 选项：WAV（默认）、MP3
  - 采样率设置
  - 声道设置

- **快捷键配置组**
  - 开始录音快捷键设置
    - 快捷键输入框
    - 重置按钮
  - 结束录音快捷键设置
    - 快捷键输入框
    - 重置按钮
  - 快捷键冲突检测
  - 应用按钮

#### 3. 任务详情页 (TaskDetailWindow)
- **布局结构**
  - 顶部工具栏
  - 内容区域
  - 底部状态栏

- **工具栏**
  - 返回按钮
  - 删除按钮
    - 带确认对话框
  - 打开文件位置按钮
  - 导出按钮

- **信息展示区**
  - 任务 ID 显示
  - 创建时间显示
    - 格式：YYYY-MM-DD HH:mm:ss
  - 录音时长
  - 转录文本区域
    - 支持文本选择
    - 支持复制
    - 支持导出
  - 原始音频播放器
    - 播放/暂停控制
    - 进度条
    - 音量控制

### 交互设计

#### 全局交互
- 支持键盘快捷键导航
- 支持深色模式自动切换
- 窗口大小可调整

#### 状态反馈
- 录音状态实时显示
- 转录状态指示
- 操作成功/失败提示
- 网络状态指示

#### 错误处理
- 友好的错误提示
- 操作确认对话框
- 自动重试机制
- 错误恢复建议

### 响应式设计
- 支持不同窗口尺寸
- 自适应布局
- 合理的空间利用
- 保持界面元素比例

---

**设计亮点：**
- 快捷键项不会因 key 变动丢失或错乱，所有配置项都以 action 唯一标识，前后端同步一致
- 全局快捷键监听无需第三方依赖，跨平台兼容性强，后台运行稳定